!function(){function e(e){function t(e){!(0<l.length)&&e.type==CKEDITOR.NODE_ELEMENT&&m.test(e.getName())&&!e.getCustomData("selected_cell")&&(CKEDITOR.dom.element.setMarker(n,e,"selected_cell",!0),l.push(e))}for(var e=e.getRanges(),l=[],n={},r=0;r<e.length;r++){var o=e[r];if(o.collapsed)o=o.getCommonAncestor(),(o=o.getAscendant("td",!0)||o.getAscendant("th",!0))&&l.push(o);else{var a,o=new CKEDITOR.dom.walker(o);for(o.guard=t;a=o.next();)a.type==CKEDITOR.NODE_ELEMENT&&a.is(CKEDITOR.dtd.table)||(a=a.getAscendant("td",!0)||a.getAscendant("th",!0))&&!a.getCustomData("selected_cell")&&(CKEDITOR.dom.element.setMarker(n,a,"selected_cell",!0),l.push(a))}}return CKEDITOR.dom.element.clearAllMarkers(n),l}function t(t,l){for(var n=e(t),r=n[0],o=r.getAscendant("table"),r=r.getDocument(),a=n[0].getParent(),c=a.$.rowIndex,n=n[n.length-1],i=n.getParent().$.rowIndex+n.$.rowSpan-1,n=new CKEDITOR.dom.element(o.$.rows[i]),c=l?c:i,a=l?a:n,n=CKEDITOR.tools.buildTableMap(o),o=n[c],c=l?n[c-1]:n[c+1],n=n[0].length,r=r.createElement("tr"),i=0;o[i]&&n>i;i++){var d;1<o[i].rowSpan&&c&&o[i]==c[i]?(d=o[i],d.rowSpan+=1):(d=new CKEDITOR.dom.element(o[i]).clone(),d.removeAttribute("rowSpan"),!CKEDITOR.env.ie&&d.appendBogus(),r.append(d),d=d.$),i+=d.colSpan-1}l?r.insertBefore(a):r.insertAfter(a)}function l(t){if(t instanceof CKEDITOR.dom.selection){for(var n=e(t),r=n[0].getAscendant("table"),o=CKEDITOR.tools.buildTableMap(r),t=n[0].getParent().$.rowIndex,n=n[n.length-1],a=n.getParent().$.rowIndex+n.$.rowSpan-1,n=[],c=t;a>=c;c++){for(var i=o[c],d=new CKEDITOR.dom.element(r.$.rows[c]),s=0;s<i.length;s++){var u=new CKEDITOR.dom.element(i[s]),m=u.getParent().$.rowIndex;1==u.$.rowSpan?u.remove():(u.$.rowSpan-=1,m==c&&(m=o[c+1],m[s-1]?u.insertAfter(new CKEDITOR.dom.element(m[s-1])):new CKEDITOR.dom.element(r.$.rows[c+1]).append(u,1))),s+=u.$.colSpan-1}n.push(d)}for(o=r.$.rows,r=new CKEDITOR.dom.element(o[a+1]||(t>0?o[t-1]:null)||r.$.parentNode),c=n.length;c>=0;c--)l(n[c]);return r}return t instanceof CKEDITOR.dom.element&&(r=t.getAscendant("table"),1==r.$.rows.length?r.remove():t.remove()),null}function n(e,t){for(var l=t?1/0:0,n=0;n<e.length;n++){var r;r=e[n];for(var o=t,a=r.getParent().$.cells,c=0,i=0;i<a.length;i++){var d=a[i],c=c+(o?1:d.colSpan);if(d==r.$)break}r=c-1,(t?l>r:r>l)&&(l=r)}return l}function r(t,l){for(var r=e(t),o=r[0].getAscendant("table"),a=n(r,1),r=n(r),a=l?a:r,c=CKEDITOR.tools.buildTableMap(o),o=[],r=[],i=c.length,d=0;i>d;d++)o.push(c[d][a]),r.push(l?c[d][a-1]:c[d][a+1]);for(d=0;i>d;d++)o[d]&&(1<o[d].colSpan&&r[d]==o[d]?(a=o[d],a.colSpan+=1):(a=new CKEDITOR.dom.element(o[d]).clone(),a.removeAttribute("colSpan"),!CKEDITOR.env.ie&&a.appendBogus(),a[l?"insertBefore":"insertAfter"].call(a,new CKEDITOR.dom.element(o[d])),a=a.$),d+=a.rowSpan-1)}function o(e,t){var l=e.getStartElement();if(l=l.getAscendant("td",1)||l.getAscendant("th",1)){var n=l.clone();CKEDITOR.env.ie||n.appendBogus(),t?n.insertBefore(l):n.insertAfter(l)}}function a(t){if(t instanceof CKEDITOR.dom.selection){var l,t=e(t),n=t[0]&&t[0].getAscendant("table");e:{var r=0;l=t.length-1;for(var o,i,d={};o=t[r++];)CKEDITOR.dom.element.setMarker(d,o,"delete_cell",!0);for(r=0;o=t[r++];)if((i=o.getPrevious())&&!i.getCustomData("delete_cell")||(i=o.getNext())&&!i.getCustomData("delete_cell")){CKEDITOR.dom.element.clearAllMarkers(d),l=i;break e}CKEDITOR.dom.element.clearAllMarkers(d),i=t[0].getParent(),(i=i.getPrevious())?l=i.getLast():(i=t[l].getParent(),l=(i=i.getNext())?i.getChild(0):null)}for(i=t.length-1;i>=0;i--)a(t[i]);l?c(l,!0):n&&n.remove()}else t instanceof CKEDITOR.dom.element&&(n=t.getParent(),1==n.getChildCount()?n.remove():t.remove())}function c(e,t){var l=new CKEDITOR.dom.range(e.getDocument());l["moveToElementEdit"+(t?"End":"Start")](e)||(l.selectNodeContents(e),l.collapse(t?!1:!0)),l.select(!0)}function i(e,t,l){if(e=e[t],"undefined"==typeof l)return e;for(t=0;e&&t<e.length;t++){if(l.is&&e[t]==l.$)return t;if(t==l)return new CKEDITOR.dom.element(e[t])}return l.is?-1:null}function d(t,l,n){var r,o=e(t);if((l?1!=o.length:2>o.length)||(r=t.getCommonAncestor())&&r.type==CKEDITOR.NODE_ELEMENT&&r.is("table"))return!1;var a,t=o[0];r=t.getAscendant("table");var c=CKEDITOR.tools.buildTableMap(r),d=c.length,s=c[0].length,u=t.getParent().$.rowIndex,m=i(c,u,t);if(l){var g;try{var T=parseInt(t.getAttribute("rowspan"),10)||1;a=parseInt(t.getAttribute("colspan"),10)||1,g=c["up"==l?u-T:"down"==l?u+T:u]["left"==l?m-a:"right"==l?m+a:m]}catch(p){return!1}if(!g||t.$==g)return!1;o["up"==l||"left"==l?"unshift":"push"](new CKEDITOR.dom.element(g))}for(var l=t.getDocument(),I=u,T=g=0,f=!n&&new CKEDITOR.dom.documentFragment(l),b=0,l=0;l<o.length;l++){a=o[l];var E=a.getParent(),C=a.getFirst(),D=a.$.colSpan,w=a.$.rowSpan,E=E.$.rowIndex,R=i(c,E,a),b=b+D*w,T=Math.max(T,R-m+D);g=Math.max(g,E-u+w),n||(D=a,(w=D.getBogus())&&w.remove(),D.trim(),a.getChildren().count()&&(E==I||!C||C.isBlockBoundary&&C.isBlockBoundary({br:1})||(I=f.getLast(CKEDITOR.dom.walker.whitespaces(!0)))&&(!I.is||!I.is("br"))&&f.append("br"),a.moveChildren(f)),l?a.remove():a.setHtml("")),I=E}if(n)return g*T==b;for(f.moveChildren(t),CKEDITOR.env.ie||t.appendBogus(),T>=s?t.removeAttribute("rowSpan"):t.$.rowSpan=g,g>=d?t.removeAttribute("colSpan"):t.$.colSpan=T,n=new CKEDITOR.dom.nodeList(r.$.rows),o=n.count(),l=o-1;l>=0;l--)r=n.getItem(l),r.$.cells.length||(r.remove(),o++);return t}function s(t,l){var n=e(t);if(1<n.length)return!1;if(l)return!0;var r,n=n[0],o=n.getParent(),a=o.getAscendant("table"),c=CKEDITOR.tools.buildTableMap(a),d=o.$.rowIndex,s=i(c,d,n),u=n.$.rowSpan;if(u>1){r=Math.ceil(u/2);for(var m,u=Math.floor(u/2),o=d+r,a=new CKEDITOR.dom.element(a.$.rows[o]),c=i(c,o),o=n.clone(),d=0;d<c.length;d++){if(m=c[d],m.parentNode==a.$&&d>s){o.insertBefore(new CKEDITOR.dom.element(m));break}m=null}m||a.append(o,!0)}else for(u=r=1,a=o.clone(),a.insertAfter(o),a.append(o=n.clone()),m=i(c,d),s=0;s<m.length;s++)m[s].rowSpan++;return CKEDITOR.env.ie||o.appendBogus(),n.$.rowSpan=r,o.$.rowSpan=u,1==r&&n.removeAttribute("rowSpan"),1==u&&o.removeAttribute("rowSpan"),o}function u(t,l){var n=e(t);if(1<n.length)return!1;if(l)return!0;var n=n[0],r=n.getParent(),o=r.getAscendant("table"),o=CKEDITOR.tools.buildTableMap(o),a=i(o,r.$.rowIndex,n),c=n.$.colSpan;if(c>1)r=Math.ceil(c/2),c=Math.floor(c/2);else{for(var c=r=1,d=[],s=0;s<o.length;s++){var u=o[s];d.push(u[a]),1<u[a].rowSpan&&(s+=u[a].rowSpan-1)}for(o=0;o<d.length;o++)d[o].colSpan++}return o=n.clone(),o.insertAfter(n),CKEDITOR.env.ie||o.appendBogus(),n.$.colSpan=r,o.$.colSpan=c,1==r&&n.removeAttribute("colSpan"),1==c&&o.removeAttribute("colSpan"),o}var m=/^(?:td|th)$/;CKEDITOR.plugins.tabletools={requires:"table,dialog,contextmenu",init:function(n){function i(e){return CKEDITOR.tools.extend(e||{},{contextSensitive:1,refresh:function(e,t){this.setState(t.contains({td:1,th:1},1)?CKEDITOR.TRISTATE_OFF:CKEDITOR.TRISTATE_DISABLED)}})}function m(e,t){var l=n.addCommand(e,t);n.addFeature(l)}var g=n.lang.table;m("cellProperties",new CKEDITOR.dialogCommand("cellProperties",i({allowedContent:"td th{width,height,border-color,background-color,white-space,vertical-align,text-align}[colspan,rowspan]",requiredContent:"table"}))),CKEDITOR.dialog.add("cellProperties",this.path+"dialogs/tableCell.js"),m("rowDelete",i({requiredContent:"table",exec:function(e){e=e.getSelection(),c(l(e))}})),m("rowInsertBefore",i({requiredContent:"table",exec:function(e){e=e.getSelection(),t(e,!0)}})),m("rowInsertAfter",i({requiredContent:"table",exec:function(e){e=e.getSelection(),t(e)}})),m("columnDelete",i({requiredContent:"table",exec:function(t){for(var l,n,t=t.getSelection(),t=e(t),r=t[0],o=t[t.length-1],t=r.getAscendant("table"),a=CKEDITOR.tools.buildTableMap(t),i=[],d=0,s=a.length;s>d;d++)for(var u=0,m=a[d].length;m>u;u++)a[d][u]==r.$&&(l=u),a[d][u]==o.$&&(n=u);for(d=l;n>=d;d++)for(u=0;u<a.length;u++)o=a[u],r=new CKEDITOR.dom.element(t.$.rows[u]),o=new CKEDITOR.dom.element(o[d]),o.$&&(1==o.$.colSpan?o.remove():o.$.colSpan-=1,u+=o.$.rowSpan-1,r.$.cells.length||i.push(r));n=t.$.rows[0]&&t.$.rows[0].cells,l=new CKEDITOR.dom.element(n[l]||(l?n[l-1]:t.$.parentNode)),i.length==s&&t.remove(),l&&c(l,!0)}})),m("columnInsertBefore",i({requiredContent:"table",exec:function(e){e=e.getSelection(),r(e,!0)}})),m("columnInsertAfter",i({requiredContent:"table",exec:function(e){e=e.getSelection(),r(e)}})),m("cellDelete",i({requiredContent:"table",exec:function(e){e=e.getSelection(),a(e)}})),m("cellMerge",i({allowedContent:"td[colspan,rowspan]",requiredContent:"td[colspan,rowspan]",exec:function(e){c(d(e.getSelection()),!0)}})),m("cellMergeRight",i({allowedContent:"td[colspan]",requiredContent:"td[colspan]",exec:function(e){c(d(e.getSelection(),"right"),!0)}})),m("cellMergeDown",i({allowedContent:"td[rowspan]",requiredContent:"td[rowspan]",exec:function(e){c(d(e.getSelection(),"down"),!0)}})),m("cellVerticalSplit",i({allowedContent:"td[rowspan]",requiredContent:"td[rowspan]",exec:function(e){c(s(e.getSelection()))}})),m("cellHorizontalSplit",i({allowedContent:"td[colspan]",requiredContent:"td[colspan]",exec:function(e){c(u(e.getSelection()))}})),m("cellInsertBefore",i({requiredContent:"table",exec:function(e){e=e.getSelection(),o(e,!0)}})),m("cellInsertAfter",i({requiredContent:"table",exec:function(e){e=e.getSelection(),o(e)}})),n.addMenuItems&&n.addMenuItems({tablecell:{label:g.cell.menu,group:"tablecell",order:1,getItems:function(){var t=n.getSelection(),l=e(t);return{tablecell_insertBefore:CKEDITOR.TRISTATE_OFF,tablecell_insertAfter:CKEDITOR.TRISTATE_OFF,tablecell_delete:CKEDITOR.TRISTATE_OFF,tablecell_merge:d(t,null,!0)?CKEDITOR.TRISTATE_OFF:CKEDITOR.TRISTATE_DISABLED,tablecell_merge_right:d(t,"right",!0)?CKEDITOR.TRISTATE_OFF:CKEDITOR.TRISTATE_DISABLED,tablecell_merge_down:d(t,"down",!0)?CKEDITOR.TRISTATE_OFF:CKEDITOR.TRISTATE_DISABLED,tablecell_split_vertical:s(t,!0)?CKEDITOR.TRISTATE_OFF:CKEDITOR.TRISTATE_DISABLED,tablecell_split_horizontal:u(t,!0)?CKEDITOR.TRISTATE_OFF:CKEDITOR.TRISTATE_DISABLED,tablecell_properties:0<l.length?CKEDITOR.TRISTATE_OFF:CKEDITOR.TRISTATE_DISABLED}}},tablecell_insertBefore:{label:g.cell.insertBefore,group:"tablecell",command:"cellInsertBefore",order:5},tablecell_insertAfter:{label:g.cell.insertAfter,group:"tablecell",command:"cellInsertAfter",order:10},tablecell_delete:{label:g.cell.deleteCell,group:"tablecell",command:"cellDelete",order:15},tablecell_merge:{label:g.cell.merge,group:"tablecell",command:"cellMerge",order:16},tablecell_merge_right:{label:g.cell.mergeRight,group:"tablecell",command:"cellMergeRight",order:17},tablecell_merge_down:{label:g.cell.mergeDown,group:"tablecell",command:"cellMergeDown",order:18},tablecell_split_horizontal:{label:g.cell.splitHorizontal,group:"tablecell",command:"cellHorizontalSplit",order:19},tablecell_split_vertical:{label:g.cell.splitVertical,group:"tablecell",command:"cellVerticalSplit",order:20},tablecell_properties:{label:g.cell.title,group:"tablecellproperties",command:"cellProperties",order:21},tablerow:{label:g.row.menu,group:"tablerow",order:1,getItems:function(){return{tablerow_insertBefore:CKEDITOR.TRISTATE_OFF,tablerow_insertAfter:CKEDITOR.TRISTATE_OFF,tablerow_delete:CKEDITOR.TRISTATE_OFF}}},tablerow_insertBefore:{label:g.row.insertBefore,group:"tablerow",command:"rowInsertBefore",order:5},tablerow_insertAfter:{label:g.row.insertAfter,group:"tablerow",command:"rowInsertAfter",order:10},tablerow_delete:{label:g.row.deleteRow,group:"tablerow",command:"rowDelete",order:15},tablecolumn:{label:g.column.menu,group:"tablecolumn",order:1,getItems:function(){return{tablecolumn_insertBefore:CKEDITOR.TRISTATE_OFF,tablecolumn_insertAfter:CKEDITOR.TRISTATE_OFF,tablecolumn_delete:CKEDITOR.TRISTATE_OFF}}},tablecolumn_insertBefore:{label:g.column.insertBefore,group:"tablecolumn",command:"columnInsertBefore",order:5},tablecolumn_insertAfter:{label:g.column.insertAfter,group:"tablecolumn",command:"columnInsertAfter",order:10},tablecolumn_delete:{label:g.column.deleteColumn,group:"tablecolumn",command:"columnDelete",order:15}}),n.contextMenu&&n.contextMenu.addListener(function(e,t,l){return(e=l.contains({td:1,th:1},1))&&!e.isReadOnly()?{tablecell:CKEDITOR.TRISTATE_OFF,tablerow:CKEDITOR.TRISTATE_OFF,tablecolumn:CKEDITOR.TRISTATE_OFF}:null})},getSelectedCells:e},CKEDITOR.plugins.add("tabletools",CKEDITOR.plugins.tabletools)}(),CKEDITOR.tools.buildTableMap=function(e){for(var e=e.$.rows,t=-1,l=[],n=0;n<e.length;n++){t++,!l[t]&&(l[t]=[]);for(var r=-1,o=0;o<e[n].cells.length;o++){var a=e[n].cells[o];for(r++;l[t][r];)r++;for(var c=isNaN(a.colSpan)?1:a.colSpan,a=isNaN(a.rowSpan)?1:a.rowSpan,i=0;a>i;i++){l[t+i]||(l[t+i]=[]);for(var d=0;c>d;d++)l[t+i][r+d]=e[n].cells[o]}r+=c-1}}return l};