CKEDITOR.plugins.add("floatpanel",{requires:"panel"}),function(){function e(e,i,o,n,s){var s=CKEDITOR.tools.genKey(i.getUniqueId(),o.getUniqueId(),e.lang.dir,e.uiColor||"",n.css||"",s||""),l=t[s];return l||(l=t[s]=new CKEDITOR.ui.panel(i,n),l.element=o.append(CKEDITOR.dom.element.createFromHtml(l.render(e),i)),l.element.setStyles({display:"none",position:"absolute"})),l}var t={};CKEDITOR.ui.floatPanel=CKEDITOR.tools.createClass({$:function(t,i,o,n){function s(){a.hide()}o.forceIFrame=1,o.toolbarRelated&&t.elementMode==CKEDITOR.ELEMENT_MODE_INLINE&&(i=CKEDITOR.document.getById("cke_"+t.name));var l=i.getDocument(),n=e(t,l,i,o,n||0),h=n.element,d=h.getFirst(),a=this;h.disableContextMenu(),this.element=h,this._={editor:t,panel:n,parentElement:i,definition:o,document:l,iframe:d,children:[],dir:t.lang.dir},t.on("mode",s),t.on("resize",s),l.getWindow().on("resize",s)},proto:{addBlock:function(e,t){return this._.panel.addBlock(e,t)},addListBlock:function(e,t){return this._.panel.addListBlock(e,t)},getBlock:function(e){return this._.panel.getBlock(e)},showBlock:function(e,t,i,o,n,s){var l=this._.panel,h=l.showBlock(e);this.allowBlur(!1),e=this._.editor.editable(),this._.returnFocus=e.hasFocus?e:new CKEDITOR.dom.element(CKEDITOR.document.$.activeElement);var d=this.element,e=this._.iframe,e=CKEDITOR.env.ie?e:new CKEDITOR.dom.window(e.$.contentWindow),a=d.getDocument(),r=this._.parentElement.getPositionedAncestor(),c=t.getDocumentPosition(a),a=r?r.getDocumentPosition(a):{x:0,y:0},u="rtl"==this._.dir,f=c.x+(o||0)-a.x,m=c.y+(n||0)-a.y;!u||1!=i&&4!=i?u||2!=i&&3!=i||(f+=t.$.offsetWidth-1):f+=t.$.offsetWidth,(3==i||4==i)&&(m+=t.$.offsetHeight-1),this._.panel._.offsetParentId=t.getId(),d.setStyles({top:m+"px",left:0,display:""}),d.setOpacity(0),d.getFirst().removeStyle("width"),this._.editor.focusManager.add(e),this._.blurSet||(CKEDITOR.event.useCapture=!0,e.on("blur",function(e){this.allowBlur()&&e.data.getPhase()==CKEDITOR.EVENT_PHASE_AT_TARGET&&this.visible&&!this._.activeChild&&(delete this._.returnFocus,this.hide())},this),e.on("focus",function(){this._.focused=!0,this.hideChild(),this.allowBlur(!0)},this),CKEDITOR.event.useCapture=!1,this._.blurSet=1),l.onEscape=CKEDITOR.tools.bind(function(e){return this.onEscape&&this.onEscape(e)===!1?!1:void 0},this),CKEDITOR.tools.setTimeout(function(){var e=CKEDITOR.tools.bind(function(){if(d.removeStyle("width"),h.autoSize){var e=h.element.getDocument(),e=(CKEDITOR.env.webkit?h.element:e.getBody()).$.scrollWidth;CKEDITOR.env.ie&&CKEDITOR.env.quirks&&e>0&&(e+=(d.$.offsetWidth||0)-(d.$.clientWidth||0)+3),d.setStyle("width",e+10+"px"),e=h.element.$.scrollHeight,CKEDITOR.env.ie&&CKEDITOR.env.quirks&&e>0&&(e+=(d.$.offsetHeight||0)-(d.$.clientHeight||0)+3),d.setStyle("height",e+"px"),l._.currentBlock.element.setStyle("display","none").removeStyle("display")}else d.removeStyle("height");u&&(f-=d.$.offsetWidth),d.setStyle("left",f+"px");var t=l.element.getWindow(),e=d.$.getBoundingClientRect(),t=t.getViewPaneSize(),i=e.width||e.right-e.left,o=e.height||e.bottom-e.top,n=u?e.right:t.width-e.left,a=u?t.width-e.right:e.left;u?i>n&&(f=a>i?f+i:t.width>i?f-e.left:f-e.right+t.width):i>n&&(f=a>i?f-i:t.width>i?f-e.right+t.width:f-e.left),i=e.top,t.height-e.top<o&&(m=i>o?m-o:t.height>o?m-e.bottom+t.height:m-e.top),CKEDITOR.env.ie&&(t=e=new CKEDITOR.dom.element(d.$.offsetParent),"html"==t.getName()&&(t=t.getDocument().getBody()),"rtl"==t.getComputedStyle("direction")&&(f=CKEDITOR.env.ie8Compat?f-2*d.getDocument().getDocumentElement().$.scrollLeft:f-(e.$.scrollWidth-e.$.clientWidth)));var r,e=d.getFirst();(r=e.getCustomData("activePanel"))&&r.onHide&&r.onHide.call(this,1),e.setCustomData("activePanel",this),d.setStyles({top:m+"px",left:f+"px"}),d.setOpacity(1),s&&s()},this);l.isLoaded?e():l.onLoad=e,CKEDITOR.tools.setTimeout(function(){this.focus(),this.allowBlur(!0),this._.editor.fire("panelShow",this)},0,this)},CKEDITOR.env.air?200:0,this),this.visible=1,this.onShow&&this.onShow.call(this)},focus:function(){if(CKEDITOR.env.webkit){var e=CKEDITOR.document.getActive();!e.equals(this._.iframe)&&e.$.blur()}(this._.lastFocused||this._.iframe.getFrameDocument().getWindow()).focus()},blur:function(){var e=this._.iframe.getFrameDocument().getActive();e.is("a")&&(this._.lastFocused=e)},hide:function(e){!this.visible||this.onHide&&!0===this.onHide.call(this)||(this.hideChild(),CKEDITOR.env.gecko&&this._.iframe.getFrameDocument().$.activeElement.blur(),this.element.setStyle("display","none"),this.visible=0,this.element.getFirst().removeCustomData("activePanel"),(e=e&&this._.returnFocus)&&(CKEDITOR.env.webkit&&e.type&&e.getWindow().$.focus(),e.focus()),delete this._.lastFocused,this._.editor.fire("panelHide",this))},allowBlur:function(e){var t=this._.panel;return void 0!=e&&(t.allowBlur=e),t.allowBlur},showAsChild:function(e,t,i,o,n,s){this._.activeChild==e&&e._.panel._.offsetParentId==i.getId()||(this.hideChild(),e.onHide=CKEDITOR.tools.bind(function(){CKEDITOR.tools.setTimeout(function(){this._.focused||this.hide()},0,this)},this),this._.activeChild=e,this._.focused=!1,e.showBlock(t,i,o,n,s),this.blur(),(CKEDITOR.env.ie7Compat||CKEDITOR.env.ie6Compat)&&setTimeout(function(){e.element.getChild(0).$.style.cssText+=""},100))},hideChild:function(e){var t=this._.activeChild;t&&(delete t.onHide,delete this._.activeChild,t.hide(),e&&this.focus())}}}),CKEDITOR.on("instanceDestroyed",function(){var e,i=CKEDITOR.tools.isEmpty(CKEDITOR.instances);for(e in t){var o=t[e];i?o.destroy():o.element.hide()}i&&(t={})})}();