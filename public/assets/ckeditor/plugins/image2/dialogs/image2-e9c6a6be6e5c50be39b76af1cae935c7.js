CKEDITOR.dialog.add("image2",function(t){function e(){var t=this.getValue().match(D);return(t=!(!t||0===parseInt(t[1],10)))||alert(y["invalid"+CKEDITOR.tools.capitalize(this.id)]),t}function a(){function t(t,i){a.push(e.once(t,function(t){for(var e;e=a.pop();)e.removeListener();i(t)}))}var e=l.createElement("img"),a=[];return function(a,i,n){t("load",function(){i.call(n,e,e.$.width,e.$.height)}),t("error",function(){i(null)}),t("abort",function(){i(null)}),e.setAttribute("src",a+"?"+Math.random().toString(16).substring(2))}}function i(){if(p){var t=this.getValue();if(t&&(t.match(D)||n(!1),"0"!==t)){var e="width"==this.id,a=d||r,i=h||g,t=Math.round(e?i*(t/a):a*(t/i));isNaN(t)||(e?k:V).setValue(t)}}}function n(t){if(v){var e;if("check"!=t||m)"boolean"==typeof t?p=t:(m=!0,p=!p,t=V.getValue(),p&&t&&(e=h/d*t,isNaN(e)||k.setValue(Math.round(e))));else{t=V.getValue(),e=k.getValue();var a=1e3*r/g,i=1e3*t/e;p=!1,t||e?!isNaN(a+i)&&Math.round(a)==Math.round(i)&&(p=!0):p=!0}v[p?"removeClass":"addClass"]("cke_btn_unlocked"),v.setAttribute("aria-checked",p),CKEDITOR.env.hc&&v.getChild(0).setHtml(p?CKEDITOR.env.ie?"■":"▣":CKEDITOR.env.ie?"□":"▢")}}function o(t){t=t?"enable":"disable",V[t](),k[t]()}var l,s,u,c,d,h,r,g,f,p,m,v,b,V,k,D=/(^\s*(\d+)(px)?\s*$)|^$/i,C=CKEDITOR.tools.getNextId(),x=CKEDITOR.tools.getNextId(),I=t.lang.image2,y=t.lang.common,t=new CKEDITOR.template('<div><a href="javascript:void(0)" tabindex="-1" title="'+I.lockRatio+'" class="cke_btn_locked" id="{lockButtonId}" role="checkbox"><span class="cke_icon"></span><span class="cke_label">'+I.lockRatio+'</span></a><a href="javascript:void(0)" tabindex="-1" title="'+I.resetSize+'" class="cke_btn_reset" id="{resetButtonId}" role="button"><span class="cke_label">'+I.resetSize+"</span></a></div>").output({lockButtonId:C,resetButtonId:x});return{title:I.title,minWidth:250,minHeight:100,onLoad:function(){l=this._.element.getDocument(),c=a()},onShow:function(){s=this._.widget,u=s.parts.image,r=g=f=m=p=!1,d=u.$.naturalWidth,h=u.$.naturalHeight,setTimeout(function(){n("check")})},contents:[{id:"info",elements:[{id:"src",type:"text",label:y.url,onKeyup:function(){var t=this.getValue();o(!1),t!==s.data.src?(c(t,function(t,e,a){return o(!0),t?(V.setValue(e),k.setValue(a),r=e,g=a,void n("check")):n(!1)}),f=!0):f?(o(!0),V.setValue(d),k.setValue(h),f=!1):o(!0)},setup:function(t){this.setValue(t.data.src)},commit:function(t){t.setData("src",this.getValue())},validate:CKEDITOR.dialog.validate.notEmpty(I.urlMissing)},{id:"alt",type:"text",label:I.alt,setup:function(t){this.setValue(t.data.alt)},commit:function(t){t.setData("alt",this.getValue())}},{type:"hbox",widths:["25%","25%","50%"],requiredContent:"img[width,height]",children:[{type:"text",width:"45px",id:"width",label:y.width,validate:e,onKeyUp:i,onLoad:function(){V=this},setup:function(t){this.setValue(t.data.width)},commit:function(t){t.setData("width",this.getValue())}},{type:"text",id:"height",width:"45px",label:y.height,validate:e,onKeyUp:i,onLoad:function(){k=this},setup:function(t){this.setValue(t.data.height)},commit:function(t){t.setData("height",this.getValue())}},{id:"lock",type:"html",style:"margin-top:18px;width:40px;height:20px;",onLoad:function(){function t(t){t.on("mouseover",function(){this.addClass("cke_btn_over")},t),t.on("mouseout",function(){this.removeClass("cke_btn_over")},t)}var e=this.getDialog();v=l.getById(C),b=l.getById(x),v&&(e.addFocusable(v,4),v.on("click",function(t){n(),t.data&&t.data.preventDefault()},this.getDialog()),t(v)),b&&(e.addFocusable(b,5),b.on("click",function(t){f?(V.setValue(r),k.setValue(g)):(V.setValue(d),k.setValue(h)),t.data&&t.data.preventDefault()},this),t(b))},html:t}]},{type:"hbox",id:"alignment",children:[{id:"align",type:"radio",items:[["None","none"],["Left","left"],["Center","center"],["Right","right"]],label:y.align,setup:function(t){this.setValue(t.data.align)},commit:function(t){t.setData("align",this.getValue())}}]},{id:"hasCaption",type:"checkbox",label:I.captioned,setup:function(t){this.setValue(t.data.hasCaption)},commit:function(t){t.setData("hasCaption",this.getValue())}}]}]}});