<% if @status[:offers] %>

  <% @formatted_data.each do |catalog_number, cn_scope| %>

    <% cn_scope.each_with_index do |(manufacturer, mf_scope), i| %>

      <div id="<%= manufacturer %>" class="part-title"></div>

      <div itemscope itemtype="http://schema.org/Product">

        <%= panel 'primary' do |p| %>
          <%= p.heading do %>
            <%= p.title do %>
              <span itemprop="name"><span style="display: none"><%= catalog_number %> (<%= manufacturer%>)</span> <%= mf_scope[:title] %></span>
            <% end %>
          <% end %>

          <%= p.body do %>

            <%= row do %>
              <div class="col-md-2">

                <h5 style="text-align: center">
                  <span itemprop="brand"><%= manufacturer %></span>
                  <br />
                  <small> <%= catalog_number %> </small>
                </h4>

                <div class="brands" style="clear: both; display: block; margin: 0 auto; width: 96px; height: 100px"> 
                  <%= brands_decorator mf_scope[:brand], {:title => false} %>
                </div>

                <div class="stars" style="clear: both; text-align: center; margin-bottom: 20px">
                  <%= brand_rating mf_scope[:brand] %>
                </div>

              </div>

              <div class="col-md-10">

                <%= row do %>

                  <% if @resource %>
                    <% css_class = "col-md-12" %>
                  <% else %>
                    <% css_class = "col-md-8" %>
                  <% end %>

                  <div class="<%= css_class %>">

                    <div itemprop="description">
                      <% if mf_scope[:titles].size > 0 %>
                        <em>Прочие названия детали:</em><br />
                        <p><%= raw mf_scope[:titles].keys.map{|val| h(val)}.join(', ') %></p>
                      <% end %>
                      <% if mf_scope[:manufacturer_origs].size > 0 %>
                        <em>Прочие написания производителя детали:</em><br />
                        <p><%= raw mf_scope[:manufacturer_origs].keys.map{|val| h(val)}.join(', ') %></p>
                      <% end %>
                      <% if mf_scope[:catalog_number_origs].size > 0 %>
                        <em>Прочие написания артикула детали:</em><br />
                        <p><%= raw mf_scope[:catalog_number_origs].keys.map{|val| h(val)}.join(', ') %></p>
                      <% end %>
                      <% if mf_scope[:weights].size > 0 %>
                        <em>Веса:</em>
                        <p><%= raw mf_scope[:weights].keys.map{|val| h("#{val} кг.")}.join(', ') %></p>
                      <% end %>
                    </div>

                    <div style="margin: 20px 0">
                      <% offer = mf_scope[:offers][0] %>
                      <%= buy_button offer, catalog_number, manufacturer, class: "btn btn-success buy-button", style: "width: 230px" do %>
                        Купить за <%= number_to_currency(offer[:retail_cost], precision: 0) %>
                        <br />
                        <small>Доставка от <%= offer[:min_days] %> до <%= offer[:max_days] %> дн.</small>
                      <% end %>
                    </div>


                  </div>

                  <% unless @resource %>

                    <div class="col-md-3">

                      <span style="display: none">
                        <div itemprop="offers" itemscope itemtype="http://schema.org/AggregateOffer">
                          <meta itemprop="priceCurrency" content="RUB" />
                          Не устраивают цена или срок доставки? Взгляните на <span itemprop="offerCount"><%= mf_scope[:offers].size %></span> лучших предложений от наших поставщиков с ценами от <span itemprop="lowPrice"><%= number_to_currency(mf_scope[:min_cost]) %></span> до <span itemprop="highPrice"><%= number_to_currency(mf_scope[:max_cost]) %></span>
                        </div>
                      </span>

                      <ul class="nav nav-pills nav-stacked">

                        <li>
                          <a href="#" class="btn btn-default" rel="tooltip show-offer" title="Другие предложения по автозапчасти">
                            <%= icon 'truck' %>
                            Предложения
                          </a>
                        </li>


                        <li>
                          <%= link_to polymorphic_path([:search, (admin_zone? ? :admin : :user), (admin_zone? ? @somebody : nil), :searches], :catalog_number => catalog_number, :manufacturer => manufacturer, :replacements => '1'), :class => 'ajax-search btn btn-default', :rel => "tooltip", :title => "Аналоги и замены \"#{catalog_number} - #{manufacturer}\"" do %>
                              <%= icon 'refresh' %> 
                              Замены
                            <% end %>
                          </a>
                        </li>


                        <li>
                          <a href="#" class="btn btn-default" rel="tooltip" title="Интерактивная карта доставки и точки самовывоза">
                            <%= icon 'globe' %> 
                            Доставка
                          </a>
                        </li>

                        <li>
                          <a href="#" class="btn btn-default" rel="tooltip" title="Задать вопрос менеджеру прямо сейчас">
                            <%= icon 'question-circle' %>
                            Вопросы?
                          </a>
                        </li>

                      </ul>

                    </div>

                  <% end %>

                <% end %>

              </div>

            <% end %>

            <% unless @resource %>
              <% css_style = "display: none;" %>
            <% else %>
              <% css_style = "display: block;" %>
            <% end %>

            <table style="<%= css_style %> margin-top: 20px" class="table table-striped" rel="offers">
              <tr>
                <th> <a href="#" rel="tooltip" title="Расположение склада поставщика">Расп.</a></th>
                <th> <a href="#" rel="tooltip" title="Способ доставки на наш склад">Дост.</a></th>
                <th> <a href="#" rel="tooltip" title="Минимальный срок поставки на наш склад">Мин.</a></th>
                <th> <a href="#" rel="tooltip" title="Максимальный срок поставки на наш склад">Макс.</a></th>
                <th> <a href="#" rel="tooltip" title="Вероятность наличия детали у поставщика">Вер.</a></th>
                <th> <a href="#" rel="tooltip" title="Количество на складе поставщика">Кол-во</a></th>
                <th> <a href="#" rel="tooltip" title="Зайдите на сайт под своим аккаунтом, чтобы увидеть вашу цену со скидками, если таковые имеются">Цена</a></th>
                <th> <a href="#" rel="tooltip" title="Служебная информация, отображается только менеджеру сайта">Служ.</a></th>
              </tr>
              <% mf_scope[:offers].each do |offer| %>
                <tr>
                  <td> <%= country_decorator offer[:country] %> </td>
                  <td> <%= offer[:delivery] %> </td>
                  <td> <%= days_decorator offer[:min_days] %> </td>
                  <td> <%= days_decorator offer[:max_days] %> </td>
                  <td> <%= offer[:probability] %>% </td>
                  <td> <%= count_decorator offer[:count] %> </td>
                  <td>
                    <%= buy_button offer, catalog_number, manufacturer, class: "btn btn-default btn-xs buy-button" do %>
                      Купить <%= number_to_currency(offer[:retail_cost], precision: 0) %>
                    <% end %>
                  </td>
                  <td> <%= offer[:tech] %> </td>
                </tr>
              <% end %>
            </table>

            <% unless @resource %>
              <% if mf_scope[:info][:own][:data].blank? %>
                <p>Хотите участвовать в жизни сайта? Будьте первым кто оставит комментарий к этой странице. Нажмите прямо на меня чтобы начать правку материла. Внимание, все материалы проверяются на предмет спама.</p>

                <%= link_to '1', new_spare_info_path(:spare_info => { :catalog_number => catalog_number, :brand_attributes => { :name => manufacturer } }, :return_path => request.fullpath) %>
              <% else %>
                <p>Хотите участвовать в жизни сайта? Заметили ошибку, неточность или ошибку в оформлении? Нажмите прямо на статью для редактирования. Внимание, все материалы проверяются на предмет спама.</p>

                <%= link_to '2', edit_spare_info_path(mf_scope[:info][:own][:data], :return_path => request.fullpath) %>

              <% end %>
            <% end %>

            <% if mf_scope[:info][:own][:status] == 'avaliable' %>
              <%= mf_scope[:info][:own][:data].content.html_safe %>
            <% end %>


          <% end %>

        <% end %>

      </div>

    <% end %>

  <% end %>

  <% if !@resource %>
    <h3>Замены артикула</h3>
    Вы так же можете попробовать посмотреть <%= link_to "замены номера #{@c9} без указания производителя", polymorphic_path([:search, (admin_zone? ? :admin : :user), (admin_zone? ? @somebody : nil), :searches], :catalog_number => @c9, :manufacturer => nil, :replacements => '1'), :class => 'ajax-search' %>.
  <% end %>

<% end %>
